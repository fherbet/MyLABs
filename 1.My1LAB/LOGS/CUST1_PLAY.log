ansible-playbook CUST1_PLAY.yml -l CUST1 -D

PLAY [IPVPN_FABRIC ALL IN ONE PLAYBOOK] ******************************************************************************************************************

TASK [get_data_pe : PUBLIC MGMT / show ip bgp vpnv4 vrf oss-new-mplsmgmt 10.255.1.11/32 | i Originator] **************************************************

TASK [get_data_pe : Display 'show ip bgp vpnv4 vrf oss-new-mplsmgmt on MGMT'] ****************************************************************************

TASK [get_data_pe : extract values from sh ip bgp | i Originator] ****************************************************************************************

TASK [get_data_pe : MGMT / show ip bgp 10.255.1.11/32 best  | i  from] ***********************************************************************************
ok: [CPE1]
ok: [CUST_DC1]
ok: [CPE2]

TASK [get_data_pe : Display 'show ip bgp  on MGMT'] ******************************************************************************************************
ok: [CPE1] =>
  config:
    changed: false
    failed: false
    stdout:
    - 10.253.1.2 (metric 20) from 10.255.1.1 (10.255.1.1)
    stdout_lines:
    - - 10.253.1.2 (metric 20) from 10.255.1.1 (10.255.1.1)
ok: [CPE2] =>
  config:
    changed: false
    failed: false
    stdout:
    - 10.253.2.2 (metric 20) from 10.255.1.2 (10.255.1.2)
    stdout_lines:
    - - 10.253.2.2 (metric 20) from 10.255.1.2 (10.255.1.2)
ok: [CUST_DC1] =>
  config:
    changed: false
    failed: false
    stdout:
    - 10.253.3.2 from 0.0.0.0 (10.255.1.3)
    stdout_lines:
    - - 10.253.3.2 from 0.0.0.0 (10.255.1.3)

TASK [get_data_pe : extract values from sh ip bgp  | i  from] ********************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg:
  - (10.255.1.1)
ok: [CPE2] =>
  msg:
  - (10.255.1.2)
ok: [CUST_DC1] =>
  msg:
  - (10.255.1.3)

TASK [get_data_pe : strip (] *****************************************************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg:
  - 10.255.1.1)
ok: [CPE2] =>
  msg:
  - 10.255.1.2)
ok: [CUST_DC1] =>
  msg:
  - 10.255.1.3)

TASK [get_data_pe : strip )] *****************************************************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg:
  - 10.255.1.1
ok: [CPE2] =>
  msg:
  - 10.255.1.2
ok: [CUST_DC1] =>
  msg:
  - 10.255.1.3

TASK [get_data_pe : search MGMT_LB_PE reverse DNS] *******************************************************************************************************
ok: [CPE1] => (item=10.255.1.1)
ok: [CPE2] => (item=10.255.1.2)
ok: [CUST_DC1] => (item=10.255.1.3)

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg: Reverse DNS for 10.255.1.1 is lo0-PE1.
ok: [CPE2] =>
  msg: Reverse DNS for 10.255.1.2 is lo0-PE2.
ok: [CUST_DC1] =>
  msg: Reverse DNS for 10.255.1.3 is lo0-MGMT.

TASK [get_data_pe : remove lo0- from from reverse] *******************************************************************************************************
ok: [CPE1] => (item=lo0-PE1.)
ok: [CPE2] => (item=lo0-PE2.)
ok: [CUST_DC1] => (item=lo0-MGMT.)

TASK [get_data_pe : remove . from from SAR_NAME] *********************************************************************************************************
ok: [CPE1] => (item=PE1.)
ok: [CPE2] => (item=PE2.)
ok: [CUST_DC1] => (item=MGMT.)

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg: after |replace Reverse DNS for [u'10.255.1.1'] is PE1
ok: [CPE2] =>
  msg: after |replace Reverse DNS for [u'10.255.1.2'] is PE2
ok: [CUST_DC1] =>
  msg: after |replace Reverse DNS for [u'10.255.1.3'] is MGMT

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg: 10.255.1.11 is advertised by PE1
ok: [CPE2] =>
  msg: 10.255.1.12 is advertised by PE2
ok: [CUST_DC1] =>
  msg: 10.255.1.13 is advertised by MGMT

TASK [get_data_pe : set fact SAR_OS for SAR OS] **********************************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg: 'PE1 OS is : iosxr'
ok: [CPE2] =>
  msg: 'PE2 OS is : iosxr'
ok: [CUST_DC1] =>
  msg: 'MGMT OS is : ios'

TASK [get_data_pe : lineinfile] **************************************************************************************************************************
ok: [CUST_DC1]
ok: [CPE1]
ok: [CPE2]

TASK [get_data_pe : sh run formal interface | remotewanip] ***********************************************************************************************
ok: [CPE2]
ok: [CPE1]

TASK [get_data_pe : print shiosxr] ***********************************************************************************************************************
ok: [CPE1] =>
  shiosxr:
    changed: false
    failed: false
    stdout:
    - interface GigabitEthernet0/0/0/1.15 ipv4 address 10.253.1.1 255.255.255.252
    stdout_lines:
    - - interface GigabitEthernet0/0/0/1.15 ipv4 address 10.253.1.1 255.255.255.252
ok: [CPE2] =>
  shiosxr:
    changed: false
    failed: false
    stdout:
    - interface GigabitEthernet0/0/0/1.25 ipv4 address 10.253.2.1 255.255.255.252
    stdout_lines:
    - - interface GigabitEthernet0/0/0/1.25 ipv4 address 10.253.2.1 255.255.255.252

TASK [get_data_pe : extract interfaces from shiosxr] *****************************************************************************************************
ok: [CPE1] => (item=interface GigabitEthernet0/0/0/1.15 ipv4 address 10.253.1.1 255.255.255.252)
ok: [CPE2] => (item=interface GigabitEthernet0/0/0/1.25 ipv4 address 10.253.2.1 255.255.255.252)

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg:
  - GigabitEthernet0/0/0/1.15
ok: [CPE2] =>
  msg:
  - GigabitEthernet0/0/0/1.25

TASK [get_data_pe : napalm_cli] **************************************************************************************************************************
ok: [CUST_DC1]

TASK [get_data_pe : print shios] *************************************************************************************************************************
ok: [CUST_DC1] =>
  shios.results:
    show ip int brie | i 10.253.3.1: GigabitEthernet0/3.1       10.253.3.1      YES NVRAM  up                    up

TASK [get_data_pe : set fact temp = shios.results] *******************************************************************************************************
ok: [CUST_DC1] => (item={'key': u'show ip int brie | i 10.253.3.1', 'value': u'GigabitEthernet0/3.1       10.253.3.1      YES NVRAM  up                    up'})

TASK [get_data_pe : extract interfaces from shios] *******************************************************************************************************
ok: [CUST_DC1] => (item=GigabitEthernet0/3.1       10.253.3.1      YES NVRAM  up                    up)

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CUST_DC1] =>
  msg: GigabitEthernet0/3.1

TASK [get_data_pe : extract PE_INT and PE_VLANID] ********************************************************************************************************
ok: [CPE1] => (item=GigabitEthernet0/0/0/1.15)
ok: [CPE2] => (item=GigabitEthernet0/0/0/1.25)
ok: [CUST_DC1] => (item=GigabitEthernet0/3.1)

TASK [get_data_pe : debug] *******************************************************************************************************************************
ok: [CPE1] =>
  msg: PE_INT is GigabitEthernet0/0/0/1 and PE_VLANID is 15
ok: [CPE2] =>
  msg: PE_INT is GigabitEthernet0/0/0/1 and PE_VLANID is 25
ok: [CUST_DC1] =>
  msg: PE_INT is GigabitEthernet0/3 and PE_VLANID is 1

TASK [get_data_pe : set fact for SAR_INT] ****************************************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [get_data_pe : lineinfile] **************************************************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [get_data_pe : set fact for SAR_VLAN_FACING_CPE_GRT] ************************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [get_data_pe : lineinfile] **************************************************************************************************************************
ok: [CPE1]
ok: [CUST_DC1]
ok: [CPE2]

TASK [bgp_pe : include BACKBONE.yml] *********************************************************************************************************************
ok: [CPE1]
ok: [CPE2]
ok: [CUST_DC1]

TASK [bgp_pe : Create target directory] ******************************************************************************************************************
--- before
+++ after
@@ -1,5 +1,5 @@
 {
-    "mode": "0775",
+    "mode": "0755",
     "path": "configs/CUST1/SITE1-SECONDARY-CPE2/",
-    "state": "absent"
+    "state": "directory"
 }

changed: [CPE2]
--- before
+++ after
@@ -1,5 +1,5 @@
 {
-    "mode": "0775",
+    "mode": "0755",
     "path": "configs/CUST1/DC1-CUST_DC1/",
-    "state": "absent"
+    "state": "directory"
 }

changed: [CUST_DC1]
--- before
+++ after
@@ -1,5 +1,5 @@
 {
-    "mode": "0775",
+    "mode": "0755",
     "path": "configs/CUST1/SITE1-PRIMARY-CPE1/",
-    "state": "absent"
+    "state": "directory"
 }

changed: [CPE1]

TASK [bgp_pe : generate PE BGP CONFIG for IOSXR PE] ******************************************************************************************************
--- before
+++ after: /tmp/tmp_7eYJC/BGP_PE_IOSXR.j2
@@ -0,0 +1,8 @@
+router bgp 65500
+  neighbor 10.253.1.2
+    timers 10 30
+    remote-as 65505
+      address-family ipv4 unicast
+        route-policy PERMIT-ALL in
+        route-policy PERMIT-ALL out
+

changed: [CPE1]
--- before
+++ after: /tmp/tmpi1j366/BGP_PE_IOSXR.j2
@@ -0,0 +1,8 @@
+router bgp 65500
+  neighbor 10.253.2.2
+    timers 10 30
+    remote-as 65505
+      address-family ipv4 unicast
+        route-policy PERMIT-ALL in
+        route-policy PERMIT-ALL out
+

changed: [CPE2]

TASK [bgp_pe : generate PE BGP CONFIG for IOS PE] ********************************************************************************************************
--- before
+++ after: /tmp/tmphLruhX/BGP_PE_IOS.j2
@@ -0,0 +1,7 @@
+router bgp 65500
+  neighbor 10.253.3.2 remote-as 65505
+  neighbor 10.253.3.2 timers 10 30
+  neighbor 10.253.3.2 description CUST_DC1
+  neighbor 10.253.3.2 send-community
+  neighbor 10.253.3.2 as-override
+end

changed: [CUST_DC1]

TASK [bgp_pe : Configure BGP Session on PE] **************************************************************************************************************
changed: [CPE2]
changed: [CPE1]
changed: [CUST_DC1]

TASK [config : Create target directory] ******************************************************************************************************************
ok: [CUST_DC1]
ok: [CPE1]
ok: [CPE2]

TASK [config : Create Basic Config] **********************************************************************************************************************
--- before
+++ after: /tmp/tmpH8sxIy/BASIC_CONFIG.j2
@@ -0,0 +1,81 @@
+!
+!
+!ip cef
+!
+!
+archive
+ path flash:archive
+ write-memory
+!
+interface Loopback0
+ description IfType[Management]
+ ip addr 10.255.1.11 255.255.255.255
+!
+interface loopback 999
+ description ConfigVersion:1.25 Bespoke Ref Nr SR_123456
+ shut
+!
+!
+service timestamps debug datetime msec localtime
+service timestamps log datetime msec localtime
+service password-encryption
+!
+logging buffered 32000 debugging
+!
+ip routing
+no ip rcmd domain-lookup
+ip rcmd rsh-enable
+no ip finger
+no ip http server
+no ip http secure-server
+!
+ip domain name PE1.ipc.colt.net
+no ip domain lookup
+!
+ip tftp source-interface Loopback0
+ip ssh source-interface Loopback0
+!
+!
+logging source-interface Loopback0
+logging trap debugging
+logging facility local6
+!
+ip classless
+!
+snmp-server location [ColtCab] / PLAYA, BARCELONA, SPAIN
+!
+
+!
+snmp-server trap-source Loopback0
+snmp-server contact inoc@xxxx.net
+snmp-server ifindex persist
+!
+ip sla responder
+!
+snmp ifmib ifalias long
+!
+!
+!
+ntp clock-period 17207933
+ntp source loopback 0
+!
+ip route 192.168.33.0 255.255.255.0 10.253.1.1
+no ip route 111.111.94.0 255.255.255.192
+no ip route 111.111.95.0 255.255.255.192
+no ip route 0.0.0.0 0.0.0.0
+!
+no access-list 10
+access-list 10 permit 10.253.1.1
+access-list 10 permit 192.168.33.0 0.0.0.255
+!
+no access-list 110
+access-list 110 deny   ip any 192.168.33.0 0.0.0.255
+access-list 110 permit ip any any
+!
+!
+line vty 0 4
+ access-class 10 in
+ exec-timeout 60 0
+ transport input ssh
+!
+end

changed: [CPE1]
--- before
+++ after: /tmp/tmpS3x5G0/BASIC_CONFIG.j2
@@ -0,0 +1,81 @@
+!
+!
+!ip cef
+!
+!
+archive
+ path flash:archive
+ write-memory
+!
+interface Loopback0
+ description IfType[Management]
+ ip addr 10.255.1.12 255.255.255.255
+!
+interface loopback 999
+ description ConfigVersion:1.25 Bespoke Ref Nr SR_123456
+ shut
+!
+!
+service timestamps debug datetime msec localtime
+service timestamps log datetime msec localtime
+service password-encryption
+!
+logging buffered 32000 debugging
+!
+ip routing
+no ip rcmd domain-lookup
+ip rcmd rsh-enable
+no ip finger
+no ip http server
+no ip http secure-server
+!
+ip domain name PE2.ipc.colt.net
+no ip domain lookup
+!
+ip tftp source-interface Loopback0
+ip ssh source-interface Loopback0
+!
+!
+logging source-interface Loopback0
+logging trap debugging
+logging facility local6
+!
+ip classless
+!
+snmp-server location [ColtCab] / PLAYA, BARCELONA, SPAIN
+!
+
+!
+snmp-server trap-source Loopback0
+snmp-server contact inoc@xxxx.net
+snmp-server ifindex persist
+!
+ip sla responder
+!
+snmp ifmib ifalias long
+!
+!
+!
+ntp clock-period 17207933
+ntp source loopback 0
+!
+ip route 192.168.33.0 255.255.255.0 10.253.2.1
+no ip route 111.111.94.0 255.255.255.192
+no ip route 111.111.95.0 255.255.255.192
+no ip route 0.0.0.0 0.0.0.0
+!
+no access-list 10
+access-list 10 permit 10.253.2.1
+access-list 10 permit 192.168.33.0 0.0.0.255
+!
+no access-list 110
+access-list 110 deny   ip any 192.168.33.0 0.0.0.255
+access-list 110 permit ip any any
+!
+!
+line vty 0 4
+ access-class 10 in
+ exec-timeout 60 0
+ transport input ssh
+!
+end

changed: [CPE2]
--- before
+++ after: /tmp/tmpHI7VdU/BASIC_CONFIG.j2
@@ -0,0 +1,81 @@
+!
+!
+!ip cef
+!
+!
+archive
+ path flash:archive
+ write-memory
+!
+interface Loopback0
+ description IfType[Management]
+ ip addr 10.255.1.13 255.255.255.255
+!
+interface loopback 999
+ description ConfigVersion:1.25 Bespoke Ref Nr SR_123456
+ shut
+!
+!
+service timestamps debug datetime msec localtime
+service timestamps log datetime msec localtime
+service password-encryption
+!
+logging buffered 32000 debugging
+!
+ip routing
+no ip rcmd domain-lookup
+ip rcmd rsh-enable
+no ip finger
+no ip http server
+no ip http secure-server
+!
+ip domain name GMT.ipc.colt.net
+no ip domain lookup
+!
+ip tftp source-interface Loopback0
+ip ssh source-interface Loopback0
+!
+!
+logging source-interface Loopback0
+logging trap debugging
+logging facility local6
+!
+ip classless
+!
+snmp-server location [ColtCab] / PLAYA, LONDON, GB
+!
+
+!
+snmp-server trap-source Loopback0
+snmp-server contact inoc@xxxx.net
+snmp-server ifindex persist
+!
+ip sla responder
+!
+snmp ifmib ifalias long
+!
+!
+!
+ntp clock-period 17207933
+ntp source loopback 0
+!
+ip route 192.168.33.0 255.255.255.0 10.253.3.1
+no ip route 111.111.94.0 255.255.255.192
+no ip route 111.111.95.0 255.255.255.192
+no ip route 0.0.0.0 0.0.0.0
+!
+no access-list 10
+access-list 10 permit 10.253.3.1
+access-list 10 permit 192.168.33.0 0.0.0.255
+!
+no access-list 110
+access-list 110 deny   ip any 192.168.33.0 0.0.0.255
+access-list 110 permit ip any any
+!
+!
+line vty 0 4
+ access-class 10 in
+ exec-timeout 60 0
+ transport input ssh
+!
+end

changed: [CUST_DC1]

TASK [config : Create Final Config] **********************************************************************************************************************
--- before
+++ after: /tmp/tmp9uzG8j/BASE.j2
@@ -0,0 +1,229 @@
+
+!OHS SERVICE_BW REWORK
+!OHS SERVICE_BW > 8 Mbps
+!==================
+!ACTIVE VPN NUMBER
+!==================
+!ACTIVE_VPNS :[1]
+
+
+
+!LAN
+!
+
+int GigabitEthernet0/0
+ speed auto
+ duplex auto
+ description IfType[Customer:Branch] Customer[CUST1] SID[IPC01987] Site[CUST_DC1] VPN[TEST] Cust-Ref[DC1]
+ ip address 10.223.0.254 255.255.255.0
+ no cdp enable
+ no shutdown
+ ip access-group 110 in
+
+
+!WAN
+interface GigabitEthernet0/1
+ description IfType[Access] L3BEnd[MGMT] L1Circuit[LON/LON/IA-191111] Rate[8M] VPN[TEST]
+ bandwidth 8000
+ no cdp enable
+!
+
+
+
+!!# SNMP #!!
+!
+snmp-server view cutdown system included
+snmp-server view cutdown interfaces included
+snmp-server view cutdown ciscoEnvMonMIB included
+!
+access-list 20 permit 172.16.3.153
+access-list 20 permit 172.16.143.10
+access-list 20 permit 172.18.3.53
+access-list 20 permit 172.18.3.52
+access-list 20 permit 172.18.3.54
+access-list 20 permit 172.18.3.51
+access-list 20 permit 172.18.3.50
+access-list 20 permit 172.16.0.91
+access-list 20 permit 192.168.0.145
+!
+snmp-server community ZzZzZzZzZzZ view cutdown RO 20
+!!SERVICE_BW_DL > 8 Mbps
+!SERVICE_BW_UL > 8 Mbps
+!CONTENTION > False
+!!!!!!!!!!!!!!!!QOS CPE!!!!!!!!!!!!!!!!!!!!!!!
+!
+no policy-map default-qos
+!
+ip access-list extended IPC01987-Business-1-Classify
+ permit ip 172.16.50.0 0.0.0.255 any
+ permit ip any 172.16.50.0 0.0.0.255
+ permit ip 10.60.50.0 0.0.0.255 any
+ permit ip any 10.60.50.0 0.0.0.255
+ permit ip 172.16.60.0 0.0.0.255 any
+ permit ip any 172.16.60.0 0.0.0.255
+ permit ip 172.16.150.0 0.0.0.255 any
+ permit ip any 172.16.150.0 0.0.0.255
+ permit ip 172.16.151.0 0.0.0.255 any
+ permit ip any 172.16.151.0 0.0.0.255
+ permit ip 172.16.152.0 0.0.0.255 any
+ permit ip any 172.16.152.0 0.0.0.255
+ permit ip 172.16.153.0 0.0.0.255 any
+ permit ip any 172.16.153.0 0.0.0.255
+ permit ip 172.16.154.0 0.0.0.255 any
+ permit ip any 172.16.154.0 0.0.0.255
+ permit ip 172.16.155.0 0.0.0.255 any
+ permit ip any 172.16.155.0 0.0.0.255
+ permit ip 172.16.156.0 0.0.0.255 any
+ permit ip any 172.16.156.0 0.0.0.255
+ permit ip 172.16.157.0 0.0.0.255 any
+ permit ip any 172.16.157.0 0.0.0.255
+ permit ip 172.16.158.0 0.0.0.255 any
+ permit ip any 172.16.158.0 0.0.0.255
+ permit ip 172.16.159.0 0.0.0.255 any
+ permit ip any 172.16.159.0 0.0.0.255
+!
+ip access-list extended IPC01987-Business-2-Classify
+ permit tcp any any eq 2598
+ permit tcp any eq 2598 any
+ permit tcp any any eq 1494
+ permit tcp any eq 1494 any
+ permit tcp any any eq domain
+ permit tcp any eq domain any
+ permit tcp any any eq 88
+ permit tcp any eq 88 any
+ permit tcp any any eq 139
+ permit tcp any eq 139 any
+ permit tcp any any eq 135
+ permit tcp any eq 135 any
+ permit tcp any any eq 137
+ permit tcp any eq 137 any
+ permit tcp any any eq 161
+ permit tcp any eq 161 any
+ permit tcp any any eq 389
+ permit tcp any eq 389 any
+ permit tcp any any eq 5900
+ permit tcp any eq 5900 any
+ permit tcp any any eq 22
+ permit tcp any eq 22 any
+ permit tcp any any eq telnet
+ permit tcp any eq telnet any
+ permit tcp any any eq 123
+ permit tcp any eq 123 any
+ permit tcp any any eq 3268
+ permit tcp any eq 3268 any
+ permit tcp any any eq 27000
+ permit tcp any eq 27000 any
+ permit tcp any any eq 57652
+ permit tcp any eq 57652 any
+ permit tcp any any eq 7279
+ permit tcp any eq 7279 any
+ permit tcp any any eq 1688
+ permit tcp any eq 1688 any
+ permit tcp any any eq 59707
+ permit tcp any eq 59707 any
+ permit udp any any eq domain
+ permit udp any eq domain any
+ permit udp any any eq 88
+ permit udp any eq 88 any
+ permit udp any any eq ntp
+ permit udp any eq ntp any
+ permit udp any any eq netbios-ns
+ permit udp any eq netbios-ns any
+ permit udp any any eq netbios-ss
+ permit udp any eq netbios-ss any
+ permit udp any any eq 389
+ permit udp any eq 389 any
+ permit udp any any eq 5000
+ permit udp any eq 5000 any
+ permit tcp any host 172.16.0.114 eq www
+ permit tcp host 172.16.0.114 eq www any
+!
+ip access-list extended Management-Routing-Classify
+ permit ip any 212.74.95.0 0.0.0.63
+ permit ip any 212.74.94.0 0.0.0.63
+ permit ip 212.74.95.0 0.0.0.63 any
+ permit ip 212.74.94.0 0.0.0.63 any
+ permit tcp any any eq bgp
+ permit udp any eq rip any eq rip
+!
+
+class-map match-any IPC01987-Business-1-Class
+  match access-group name IPC01987-Business-1-Classify
+!
+class-map match-any IPC01987-Business-2-Class
+  match access-group name IPC01987-Business-2-Classify
+!
+class-map match-any IPC01987-Business-3-Class
+  match access-group name IPC01987-Business-3-Classify
+!
+class-map match-any Management-Routing-Class
+  match access-group name Management-Routing-Classify
+
+!
+!
+policy-map IPC01987-Profile8M-Queue
+ class IPC01987-Business-1-Class
+  bandwidth percent 20
+  set ip dscp af31
+ class IPC01987-Business-2-Class
+  bandwidth percent 45
+  set ip dscp af21
+ class Management-Routing-Class
+  bandwidth percent 4
+  set ip dscp af41
+class class-default
+  bandwidth percent 30
+  set ip dscp 0
+  random-detect
+!
+policy-map IPC01987-Profile8M-Queue-8M
+ class class-default
+  shape average 8000000
+  service-policy IPC01987-Profile8M-Queue
+!
+interface GigabitEthernet0/1
+ no service-policy output main
+ service-policy output IPC01987-Profile8M-Queue-8M
+!
+
+
+
+!!# >>>> ROUTING EU CE1 !!!!! #!!
+!
+ip bgp-community new-format
+!
+access-list 30 permit 10.255.1.13
+!
+route-map 65505-TAGGED-STATIC permit 10
+ match tag 65505
+!
+route-map REDISTRIBUTE-CONNECTED permit 10
+ match ip address 30
+ set community 8220:40001
+!
+route-map REDISTRIBUTE-CONNECTED permit 20
+!
+!
+!
+!
+!
+router bgp 65505
+ bgp log-neighbor-changes
+ redistribute connected route-map REDISTRIBUTE-CONNECTED
+ redistribute static route-map 65505-TAGGED-STATIC
+ no neighbor 10.255.80.17
+ no neighbor 10.255.80.18
+ neighbor 10.253.3.1 remote-as 65500
+ neighbor 10.253.3.1 description MGMT
+ neighbor 10.253.3.1 timers 10 30
+ neighbor 10.253.3.1 next-hop-self
+ neighbor 10.253.3.1 send-community
+ neighbor 10.253.3.1 allowas-in
+!
+!
+!
+no ip route 212.74.94.0 255.255.255.192 10.255.18.37
+no ip route 212.74.95.0 255.255.255.192 10.255.18.37
+
+
+end

changed: [CUST_DC1]
--- before
+++ after: /tmp/tmpbBPg4Y/BASE.j2
@@ -0,0 +1,360 @@
+
+!OHS SERVICE_BW REWORK
+!OHS SERVICE_BW > 4 Mbps
+!==================
+!ACTIVE VPN NUMBER
+!==================
+!ACTIVE_VPNS :[1]
+
+
+
+!LAN
+!
+
+int GigabitEthernet0/0
+ speed auto
+ duplex auto
+ description IfType[Customer:Branch] Customer[CUST1] SID[IPC01987] Site[CPE1] VPN[TEST] Cust-Ref[SITE1-PRIMARY]
+ ip address 10.223.1.252 255.255.255.0
+ no cdp enable
+ no shutdown
+ ip access-group 110 in
+ vrrp 1 ip 10.223.1.254
+ vrrp 1 preempt
+ vrrp 1 priority 110
+ vrrp 1 track 1 decrement 20
+!
+track 1 ip route 212.74.74.96 255.255.255.255 reachability
+!
+
+!B2B
+default int GigabitEthernet0/2
+int GigabitEthernet0/2
+no shut
+int GigabitEthernet0/2
+ description IfType[B2B] L3BEnd[CPE2]
+ speed auto
+ duplex auto
+!
+interface GigabitEthernet0/2.3
+ encapsulation dot1q 3
+ description IfType[B2B] L3BEnd[CPE2] VPN[TEST]
+ ip address 10.255.80.17 255.255.255.252
+!
+
+!WAN
+interface GigabitEthernet0/1
+ description IfType[Access] L3BEnd[PE1] L1Circuit[MAD/MAD/IA-194201] Rate[4M]
+ bandwidth 4000
+ no cdp enable
+!
+interface GigabitEthernet0/1.15
+ description IfType[Access] L3BEnd[PE1] L1Circuit[MAD/MAD/IA-194201] Rate[4M] VPN[TEST]
+ bandwidth 4000
+ no cdp enable
+!
+
+
+
+!!# SNMP #!!
+!
+snmp-server view cutdown system included
+snmp-server view cutdown interfaces included
+snmp-server view cutdown ciscoEnvMonMIB included
+!
+access-list 20 permit 172.16.3.153
+access-list 20 permit 172.16.143.10
+access-list 20 permit 172.18.3.53
+access-list 20 permit 172.18.3.52
+access-list 20 permit 172.18.3.54
+access-list 20 permit 172.18.3.51
+access-list 20 permit 172.18.3.50
+access-list 20 permit 172.16.0.91
+access-list 20 permit 192.168.0.145
+!
+snmp-server community ZzZzZzZzZzZ view cutdown RO 20
+!!SERVICE_BW_DL > 4 Mbps
+!SERVICE_BW_UL > 4 Mbps
+!CONTENTION > False
+!!!!!!!!!!!!!!!!QOS CPE!!!!!!!!!!!!!!!!!!!!!!!
+!
+no policy-map default-qos
+!
+ip access-list extended IPC01987-Business-1-Classify
+ permit ip 172.16.50.0 0.0.0.255 any
+ permit ip any 172.16.50.0 0.0.0.255
+ permit ip 10.60.50.0 0.0.0.255 any
+ permit ip any 10.60.50.0 0.0.0.255
+ permit ip 172.16.60.0 0.0.0.255 any
+ permit ip any 172.16.60.0 0.0.0.255
+ permit ip 172.16.150.0 0.0.0.255 any
+ permit ip any 172.16.150.0 0.0.0.255
+ permit ip 172.16.151.0 0.0.0.255 any
+ permit ip any 172.16.151.0 0.0.0.255
+ permit ip 172.16.152.0 0.0.0.255 any
+ permit ip any 172.16.152.0 0.0.0.255
+ permit ip 172.16.153.0 0.0.0.255 any
+ permit ip any 172.16.153.0 0.0.0.255
+ permit ip 172.16.154.0 0.0.0.255 any
+ permit ip any 172.16.154.0 0.0.0.255
+ permit ip 172.16.155.0 0.0.0.255 any
+ permit ip any 172.16.155.0 0.0.0.255
+ permit ip 172.16.156.0 0.0.0.255 any
+ permit ip any 172.16.156.0 0.0.0.255
+ permit ip 172.16.157.0 0.0.0.255 any
+ permit ip any 172.16.157.0 0.0.0.255
+ permit ip 172.16.158.0 0.0.0.255 any
+ permit ip any 172.16.158.0 0.0.0.255
+ permit ip 172.16.159.0 0.0.0.255 any
+ permit ip any 172.16.159.0 0.0.0.255
+!
+ip access-list extended IPC01987-Business-2-Classify
+ permit tcp any any eq 2598
+ permit tcp any eq 2598 any
+ permit tcp any any eq 1494
+ permit tcp any eq 1494 any
+ permit tcp any any eq domain
+ permit tcp any eq domain any
+ permit tcp any any eq 88
+ permit tcp any eq 88 any
+ permit tcp any any eq 139
+ permit tcp any eq 139 any
+ permit tcp any any eq 135
+ permit tcp any eq 135 any
+ permit tcp any any eq 137
+ permit tcp any eq 137 any
+ permit tcp any any eq 161
+ permit tcp any eq 161 any
+ permit tcp any any eq 389
+ permit tcp any eq 389 any
+ permit tcp any any eq 5900
+ permit tcp any eq 5900 any
+ permit tcp any any eq 22
+ permit tcp any eq 22 any
+ permit tcp any any eq telnet
+ permit tcp any eq telnet any
+ permit tcp any any eq 123
+ permit tcp any eq 123 any
+ permit tcp any any eq 3268
+ permit tcp any eq 3268 any
+ permit tcp any any eq 27000
+ permit tcp any eq 27000 any
+ permit tcp any any eq 57652
+ permit tcp any eq 57652 any
+ permit tcp any any eq 7279
+ permit tcp any eq 7279 any
+ permit tcp any any eq 1688
+ permit tcp any eq 1688 any
+ permit tcp any any eq 59707
+ permit tcp any eq 59707 any
+ permit udp any any eq domain
+ permit udp any eq domain any
+ permit udp any any eq 88
+ permit udp any eq 88 any
+ permit udp any any eq ntp
+ permit udp any eq ntp any
+ permit udp any any eq netbios-ns
+ permit udp any eq netbios-ns any
+ permit udp any any eq netbios-ss
+ permit udp any eq netbios-ss any
+ permit udp any any eq 389
+ permit udp any eq 389 any
+ permit udp any any eq 5000
+ permit udp any eq 5000 any
+ permit tcp any host 172.16.0.114 eq www
+ permit tcp host 172.16.0.114 eq www any
+!
+ip access-list extended Management-Routing-Classify
+ permit ip any 212.74.95.0 0.0.0.63
+ permit ip any 212.74.94.0 0.0.0.63
+ permit ip 212.74.95.0 0.0.0.63 any
+ permit ip 212.74.94.0 0.0.0.63 any
+ permit tcp any any eq bgp
+ permit udp any eq rip any eq rip
+!
+
+class-map match-any IPC01987-Business-1-Class
+  match access-group name IPC01987-Business-1-Classify
+!
+class-map match-any IPC01987-Business-2-Class
+  match access-group name IPC01987-Business-2-Classify
+!
+class-map match-any IPC01987-Business-3-Class
+  match access-group name IPC01987-Business-3-Classify
+!
+class-map match-any Management-Routing-Class
+  match access-group name Management-Routing-Classify
+
+!
+!
+policy-map IPC01987-Profile4M-Queue
+ class IPC01987-Business-1-Class
+  bandwidth percent 25
+  set ip dscp af31
+ class IPC01987-Business-2-Class
+  bandwidth percent 40
+  set ip dscp af21
+ class Management-Routing-Class
+  bandwidth percent 4
+  set ip dscp af41
+class class-default
+  bandwidth percent 30
+  set ip dscp 0
+  random-detect
+!
+policy-map IPC01987-Profile4M-Queue-4M
+ class class-default
+  shape average 4000000
+  service-policy IPC01987-Profile4M-Queue
+!
+interface GigabitEthernet0/1.15
+ no service-policy output main
+ service-policy output IPC01987-Profile4M-Queue-4M
+!
+
+
+
+!!# >>>> ROUTING EU CE1 !!!!! #!!
+!
+ip bgp-community new-format
+!
+access-list 30 permit 10.255.1.11
+!
+route-map 65505-TAGGED-STATIC permit 10
+ match tag 65505
+!
+route-map REDISTRIBUTE-CONNECTED permit 10
+ match ip address 30
+ set community 8220:40001
+!
+route-map REDISTRIBUTE-CONNECTED permit 20
+!
+!
+!
+ip prefix-list WWW seq 5 permit 8.8.8.8/32
+ip prefix-list B2B seq 5 permit 10.255.80.16/30
+ip prefix-list REMOTE_LB seq 5 permit 10.255.1.12/32
+!
+ip community-list 9 permit 65505:1
+!
+route-map FROM-SAR deny 10
+ match community 1
+!
+route-map FROM-SAR deny 11
+ match ip address prefix-list REMOTE_LB
+!
+ip community-list 1 permit 12345:6789
+!
+route-map FROM-SAR permit 20
+ match ip address prefix-list WWW
+ set community 65505:1
+!
+route-map FROM-SAR permit 30
+ set local-preference 250
+ set community 65505:1
+!
+!
+!
+route-map TO-SAR deny 5
+ match ip address prefix-list B2B
+!
+route-map TO-SAR deny 6
+ match community 9
+!
+route-map TO-SAR permit 10
+ match ip address prefix-list NAT
+ set community 12345:6789 additive
+ set as-path prepend 65505
+!
+route-map TO-SAR permit 20
+ set community 12345:6789 additive
+!
+!
+ip prefix-list COLT-IP seq 5 permit 192.168.33.0/24 le 32
+ip prefix-list COLT-IP seq 40 permit 212.74.74.96/32
+!
+route-map DENY-MGMT deny 10
+ match ip address prefix-list COLT-IP
+!
+route-map DENY-MGMT permit 20
+!
+!
+!
+router bgp 65505
+ bgp log-neighbor-changes
+ redistribute connected route-map REDISTRIBUTE-CONNECTED
+ redistribute static route-map 65505-TAGGED-STATIC
+ no neighbor 10.255.80.17
+ no neighbor 10.255.80.18
+ neighbor 10.253.1.1 remote-as 65500
+ neighbor 10.253.1.1 description PE1
+ neighbor 10.253.1.1 timers 10 30
+ neighbor 10.253.1.1 next-hop-self
+ neighbor 10.253.1.1 send-community
+ neighbor 10.253.1.1 allowas-in
+ neighbor 10.253.1.1 route-map FROM-SAR in
+ neighbor 10.253.1.1 route-map TO-SAR out
+ neighbor 10.255.1.12 remote-as 65505
+ neighbor 10.255.1.12 update-source Loopback0
+ neighbor 10.255.1.12 description CPE2
+ neighbor 10.255.1.12 route-map DENY-MGMT out
+ neighbor 10.255.1.12 timers 10 30
+ neighbor 10.255.1.12 next-hop-self
+ neighbor 10.255.1.12 send-community
+!
+!
+ip route 10.255.1.12 255.255.255.255 GigabitEthernet0/2.3 10.255.80.18
+ip route 10.255.1.12 255.255.255.255 GigabitEthernet0/0 10.223.1.253 250
+!
+ip ssh source-interface loopback 0
+ip access-list standard 10
+ 1 permit 10.255.1.12
+!
+no ip route 212.74.94.0 255.255.255.192 10.255.18.37
+no ip route 212.74.95.0 255.255.255.192 10.255.18.37
+
+
+
+
+
+!!! NAT FOR CUST1 in VRF TEST !!!
+!
+ip nat translation timeout never
+ip nat pool CUST1-TEST 10.123.1.1 10.123.1.254 netmask 255.255.255.0 type match-host
+ip nat inside source route-map NAT-WWW-TEST pool CUST1-TEST reversible
+!
+route-map NAT-WWW-TEST permit 10
+ match ip address 101
+!
+no access-list 101
+access-list 101 permit ip 10.223.1.0 0.0.0.255 8.8.8.8 0.0.0.0
+access-list 101 deny   ip 10.223.1.0 0.0.0.255 10.223.0.0 0.0.0.255
+access-list 101 deny   ip 10.255.0.0 0.0.255.255 any
+access-list 101 permit ip 10.223.1.0 0.0.0.255 any
+!
+
+
+
+interface GigabitEthernet0/0
+ ip nat inside
+!
+interface GigabitEthernet0/2.3
+ ip nat inside
+!
+ip route 10.123.1.0 255.255.255.0 GigabitEthernet0/0 tag 65505
+
+
+
+
+
+
+
+
+
+interface GigabitEthernet0/1.15
+ ip nat outside
+
+
+
+
+end

changed: [CPE1]
--- before
+++ after: /tmp/tmpXi9CvR/BASE.j2
@@ -0,0 +1,357 @@
+
+!OHS SERVICE_BW REWORK
+!OHS SERVICE_BW > 4 Mbps
+!==================
+!ACTIVE VPN NUMBER
+!==================
+!ACTIVE_VPNS :[1]
+
+
+
+!LAN
+!
+
+int GigabitEthernet0/0
+ speed auto
+ duplex auto
+ description IfType[Customer:Branch] Customer[CUST1] SID[IPC01987] Site[CPE2] VPN[TEST] Cust-Ref[SITE1-SECONDARY]
+ ip address 10.223.1.253 255.255.255.0
+ no cdp enable
+ no shutdown
+ ip access-group 110 in
+ vrrp 1 ip 10.223.1.254
+ vrrp 1 preempt
+ vrrp 1 priority 100
+!
+
+!B2B
+default int GigabitEthernet0/2
+int GigabitEthernet0/2
+no shut
+int GigabitEthernet0/2
+ description IfType[B2B] L3BEnd[CPE1]
+ speed auto
+ duplex auto
+!
+interface GigabitEthernet0/2.3
+ encapsulation dot1q 3
+ description IfType[B2B] L3BEnd[CPE1] VPN[TEST]
+ ip address 10.255.80.18 255.255.255.252
+!
+
+!WAN
+interface GigabitEthernet0/1
+ description IfType[Access] L3BEnd[PE2] L1Circuit[MAD/MAD/IA-194202] Rate[4M]
+ bandwidth 4000
+ no cdp enable
+!
+interface GigabitEthernet0/1.25
+ description IfType[Access] L3BEnd[PE2] L1Circuit[MAD/MAD/IA-194202] Rate[4M] VPN[TEST]
+ bandwidth 4000
+ no cdp enable
+!
+
+
+
+!!# SNMP #!!
+!
+snmp-server view cutdown system included
+snmp-server view cutdown interfaces included
+snmp-server view cutdown ciscoEnvMonMIB included
+!
+access-list 20 permit 172.16.3.153
+access-list 20 permit 172.16.143.10
+access-list 20 permit 172.18.3.53
+access-list 20 permit 172.18.3.52
+access-list 20 permit 172.18.3.54
+access-list 20 permit 172.18.3.51
+access-list 20 permit 172.18.3.50
+access-list 20 permit 172.16.0.91
+access-list 20 permit 192.168.0.145
+!
+snmp-server community ZzZzZzZzZzZ view cutdown RO 20
+!!SERVICE_BW_DL > 4 Mbps
+!SERVICE_BW_UL > 4 Mbps
+!CONTENTION > False
+!!!!!!!!!!!!!!!!QOS CPE!!!!!!!!!!!!!!!!!!!!!!!
+!
+no policy-map default-qos
+!
+ip access-list extended IPC01987-Business-1-Classify
+ permit ip 172.16.50.0 0.0.0.255 any
+ permit ip any 172.16.50.0 0.0.0.255
+ permit ip 10.60.50.0 0.0.0.255 any
+ permit ip any 10.60.50.0 0.0.0.255
+ permit ip 172.16.60.0 0.0.0.255 any
+ permit ip any 172.16.60.0 0.0.0.255
+ permit ip 172.16.150.0 0.0.0.255 any
+ permit ip any 172.16.150.0 0.0.0.255
+ permit ip 172.16.151.0 0.0.0.255 any
+ permit ip any 172.16.151.0 0.0.0.255
+ permit ip 172.16.152.0 0.0.0.255 any
+ permit ip any 172.16.152.0 0.0.0.255
+ permit ip 172.16.153.0 0.0.0.255 any
+ permit ip any 172.16.153.0 0.0.0.255
+ permit ip 172.16.154.0 0.0.0.255 any
+ permit ip any 172.16.154.0 0.0.0.255
+ permit ip 172.16.155.0 0.0.0.255 any
+ permit ip any 172.16.155.0 0.0.0.255
+ permit ip 172.16.156.0 0.0.0.255 any
+ permit ip any 172.16.156.0 0.0.0.255
+ permit ip 172.16.157.0 0.0.0.255 any
+ permit ip any 172.16.157.0 0.0.0.255
+ permit ip 172.16.158.0 0.0.0.255 any
+ permit ip any 172.16.158.0 0.0.0.255
+ permit ip 172.16.159.0 0.0.0.255 any
+ permit ip any 172.16.159.0 0.0.0.255
+!
+ip access-list extended IPC01987-Business-2-Classify
+ permit tcp any any eq 2598
+ permit tcp any eq 2598 any
+ permit tcp any any eq 1494
+ permit tcp any eq 1494 any
+ permit tcp any any eq domain
+ permit tcp any eq domain any
+ permit tcp any any eq 88
+ permit tcp any eq 88 any
+ permit tcp any any eq 139
+ permit tcp any eq 139 any
+ permit tcp any any eq 135
+ permit tcp any eq 135 any
+ permit tcp any any eq 137
+ permit tcp any eq 137 any
+ permit tcp any any eq 161
+ permit tcp any eq 161 any
+ permit tcp any any eq 389
+ permit tcp any eq 389 any
+ permit tcp any any eq 5900
+ permit tcp any eq 5900 any
+ permit tcp any any eq 22
+ permit tcp any eq 22 any
+ permit tcp any any eq telnet
+ permit tcp any eq telnet any
+ permit tcp any any eq 123
+ permit tcp any eq 123 any
+ permit tcp any any eq 3268
+ permit tcp any eq 3268 any
+ permit tcp any any eq 27000
+ permit tcp any eq 27000 any
+ permit tcp any any eq 57652
+ permit tcp any eq 57652 any
+ permit tcp any any eq 7279
+ permit tcp any eq 7279 any
+ permit tcp any any eq 1688
+ permit tcp any eq 1688 any
+ permit tcp any any eq 59707
+ permit tcp any eq 59707 any
+ permit udp any any eq domain
+ permit udp any eq domain any
+ permit udp any any eq 88
+ permit udp any eq 88 any
+ permit udp any any eq ntp
+ permit udp any eq ntp any
+ permit udp any any eq netbios-ns
+ permit udp any eq netbios-ns any
+ permit udp any any eq netbios-ss
+ permit udp any eq netbios-ss any
+ permit udp any any eq 389
+ permit udp any eq 389 any
+ permit udp any any eq 5000
+ permit udp any eq 5000 any
+ permit tcp any host 172.16.0.114 eq www
+ permit tcp host 172.16.0.114 eq www any
+!
+ip access-list extended Management-Routing-Classify
+ permit ip any 212.74.95.0 0.0.0.63
+ permit ip any 212.74.94.0 0.0.0.63
+ permit ip 212.74.95.0 0.0.0.63 any
+ permit ip 212.74.94.0 0.0.0.63 any
+ permit tcp any any eq bgp
+ permit udp any eq rip any eq rip
+!
+
+class-map match-any IPC01987-Business-1-Class
+  match access-group name IPC01987-Business-1-Classify
+!
+class-map match-any IPC01987-Business-2-Class
+  match access-group name IPC01987-Business-2-Classify
+!
+class-map match-any IPC01987-Business-3-Class
+  match access-group name IPC01987-Business-3-Classify
+!
+class-map match-any Management-Routing-Class
+  match access-group name Management-Routing-Classify
+
+!
+!
+policy-map IPC01987-Profile4M-Queue
+ class IPC01987-Business-1-Class
+  bandwidth percent 25
+  set ip dscp af31
+ class IPC01987-Business-2-Class
+  bandwidth percent 40
+  set ip dscp af21
+ class Management-Routing-Class
+  bandwidth percent 4
+  set ip dscp af41
+class class-default
+  bandwidth percent 30
+  set ip dscp 0
+  random-detect
+!
+policy-map IPC01987-Profile4M-Queue-4M
+ class class-default
+  shape average 4000000
+  service-policy IPC01987-Profile4M-Queue
+!
+interface GigabitEthernet0/1.25
+ no service-policy output main
+ service-policy output IPC01987-Profile4M-Queue-4M
+!
+
+
+
+!!# >>>> ROUTING EU CE2 !!!!! #!!
+!
+ip bgp-community new-format
+!
+access-list 30 permit 10.255.1.12
+!
+route-map 65505-TAGGED-STATIC permit 10
+ match tag 65505
+!
+route-map REDISTRIBUTE-CONNECTED permit 10
+ match ip address 30
+ set community 8220:40001
+!
+route-map REDISTRIBUTE-CONNECTED permit 20
+!
+!
+!
+ip prefix-list WWW seq 5 permit 8.8.8.8/32
+ip prefix-list B2B seq 5 permit 10.255.80.16/30
+ip prefix-list REMOTE_LB seq 5 permit 10.255.1.11/32
+!
+ip community-list 9 permit 65505:1
+!
+route-map FROM-SAR deny 10
+ match community 1
+!
+route-map FROM-SAR deny 11
+ match ip address prefix-list REMOTE_LB
+!
+ip community-list 1 permit 12345:6790
+!
+route-map FROM-SAR permit 20
+ match ip address prefix-list WWW
+ set local-preference 250
+ set community 65505:1
+!
+route-map FROM-SAR permit 30
+ set community 65505:1
+!
+!
+!
+route-map TO-SAR deny 5
+ match ip address prefix-list B2B
+!
+route-map TO-SAR deny 6
+ match community 9
+!
+route-map TO-SAR permit 10
+ match ip address prefix-list NAT
+ set community 12345:6790 additive
+!
+route-map TO-SAR permit 20
+ set community 12345:6790 additive
+ set as-path prepend 65505
+!
+!
+ip prefix-list COLT-IP seq 5 permit 192.168.33.0/24 le 32
+ip prefix-list COLT-IP seq 40 permit 212.74.74.96/32
+!
+route-map DENY-MGMT deny 10
+ match ip address prefix-list COLT-IP
+!
+route-map DENY-MGMT permit 20
+!
+!
+!
+router bgp 65505
+ bgp log-neighbor-changes
+ redistribute connected route-map REDISTRIBUTE-CONNECTED
+ redistribute static route-map 65505-TAGGED-STATIC
+ no neighbor 10.255.80.17
+ no neighbor 10.255.80.18
+ neighbor 10.253.2.1 remote-as 65500
+ neighbor 10.253.2.1 description PE2
+ neighbor 10.253.2.1 timers 10 30
+ neighbor 10.253.2.1 next-hop-self
+ neighbor 10.253.2.1 send-community
+ neighbor 10.253.2.1 allowas-in
+ neighbor 10.253.2.1 route-map FROM-SAR in
+ neighbor 10.253.2.1 route-map TO-SAR out
+ neighbor 10.255.1.11 remote-as 65505
+ neighbor 10.255.1.11 update-source Loopback0
+ neighbor 10.255.1.11 description CPE1
+ neighbor 10.255.1.11 route-map DENY-MGMT out
+ neighbor 10.255.1.11 timers 10 30
+ neighbor 10.255.1.11 next-hop-self
+ neighbor 10.255.1.11 send-community
+!
+!
+ip route 10.255.1.11 255.255.255.255 GigabitEthernet0/2.3 10.255.80.17
+ip route 10.255.1.11 255.255.255.255 GigabitEthernet0/0 10.223.1.252 250
+!
+ip ssh source-interface loopback 0
+ip access-list standard 10
+ 1 permit 10.255.1.11
+!
+no ip route 212.74.94.0 255.255.255.192 10.255.18.37
+no ip route 212.74.95.0 255.255.255.192 10.255.18.37
+
+
+
+
+
+!!! NAT FOR CUST1 in VRF TEST !!!
+!
+ip nat translation timeout never
+ip nat pool CUST1-TEST 10.123.1.1 10.123.1.254 netmask 255.255.255.0 type match-host
+ip nat inside source route-map NAT-WWW-TEST pool CUST1-TEST reversible
+!
+route-map NAT-WWW-TEST permit 10
+ match ip address 101
+!
+no access-list 101
+access-list 101 permit ip 10.223.1.0 0.0.0.255 8.8.8.8 0.0.0.0
+access-list 101 deny   ip 10.223.1.0 0.0.0.255 10.223.0.0 0.0.0.255
+access-list 101 deny   ip 10.255.0.0 0.0.255.255 any
+access-list 101 permit ip 10.223.1.0 0.0.0.255 any
+!
+
+
+
+interface GigabitEthernet0/0
+ ip nat inside
+!
+interface GigabitEthernet0/2.3
+ ip nat inside
+!
+ip route 10.123.1.0 255.255.255.0 GigabitEthernet0/0 tag 65505
+
+
+
+
+
+
+
+
+
+interface GigabitEthernet0/1.25
+ ip nat outside
+
+
+
+
+end

changed: [CPE2]

TASK [config : Create PE Qos/Shaping] ********************************************************************************************************************
--- before
+++ after: /tmp/tmpClHCGr/QOS_PE.j2
@@ -0,0 +1,31 @@
+
+
+
+
+!
+policy-map IPC01987-Profile4m-QOS-TO-CPE
+ class Business1-To-CPE
+  bandwidth percent 25
+ class Business2-To-CPE
+  bandwidth percent 40
+ class class-default
+  bandwidth percent 30
+ class Routing-Management-To-CPE
+  bandwidth percent 5
+end-policy-map
+!
+!
+policy-map IPC01987-Profile4m-QOS-TO-CPE-4M
+ class class-default
+  shape average 4000000
+   service-policy IPC01987-Profile4m-QOS-TO-CPE
+end-policy-map
+!
+!
+interface GigabitEthernet0/0/0/1.15
+ bandwidth 4000
+ no service-policy output
+ service-policy output IPC01987-Profile4m-QOS-TO-CPE-4M
+ no service-policy input
+
+!

changed: [CPE1]
--- before
+++ after: /tmp/tmpizQntS/QOS_PE.j2
@@ -0,0 +1,33 @@
+
+
+!
+policy-map IPC01987-Profile8m-QOS-TO-CPE
+ class Business1-Class-To-CPE
+  bandwidth percent 20
+  random-detect discard-class-based
+ class Business2-Class-To-CPE
+  bandwidth percent 45
+  random-detect discard-class-based
+ class Default-To-CPE
+  bandwidth percent 30
+  random-detect discard-class-based
+ class Routing-Management-To-CPE
+  bandwidth percent 5
+  random-detect discard-class-based
+!
+!
+policy-map IPC01987-Profile8m-QOS-TO-CPE-8M
+ class class-default
+  shape average 8000000
+   service-policy IPC01987-Profile8m-QOS-TO-CPE
+!
+!
+!
+!
+interface GigabitEthernet0/3.1
+
+ bandwidth 8000
+ service-policy output IPC01987-Profile8m-QOS-TO-CPE-8M
+
+!
+end

changed: [CUST_DC1]
--- before
+++ after: /tmp/tmpx8O4V6/QOS_PE.j2
@@ -0,0 +1,31 @@
+
+
+
+
+!
+policy-map IPC01987-Profile4m-QOS-TO-CPE
+ class Business1-To-CPE
+  bandwidth percent 25
+ class Business2-To-CPE
+  bandwidth percent 40
+ class class-default
+  bandwidth percent 30
+ class Routing-Management-To-CPE
+  bandwidth percent 5
+end-policy-map
+!
+!
+policy-map IPC01987-Profile4m-QOS-TO-CPE-4M
+ class class-default
+  shape average 4000000
+   service-policy IPC01987-Profile4m-QOS-TO-CPE
+end-policy-map
+!
+!
+interface GigabitEthernet0/0/0/1.25
+ bandwidth 4000
+ no service-policy output
+ service-policy output IPC01987-Profile4m-QOS-TO-CPE-4M
+ no service-policy input
+
+!

changed: [CPE2]

TASK [config : Configure Basic Config  via ssh / napalm] *************************************************************************************************
changed: [CUST_DC1]
changed: [CPE1]
changed: [CPE2]

TASK [config : Configure Final Config  via ssh / napalm] *************************************************************************************************
changed: [CUST_DC1]
changed: [CPE1]
changed: [CPE2]

TASK [config : Configure Qos/Shaping on PE] **************************************************************************************************************
changed: [CPE1]
changed: [CPE2]
changed: [CUST_DC1]

TASK [verify : REFRESH BGP sessions] *********************************************************************************************************************
ok: [CUST_DC1]
ok: [CPE2]
ok: [CPE1]

TASK [verify : CHECK / Napalm Get Facts from Device] *****************************************************************************************************
ok: [CUST_DC1]
ok: [CPE1]
ok: [CPE2]

TASK [verify : CHECK / Print BGP details] ****************************************************************************************************************
ok: [CPE1] =>
  msg:
    10.253.1.1:
      address_family:
        ipv4:
          accepted_prefixes: 20
          received_prefixes: 20
          sent_prefixes: 5
      description: PE1
      is_enabled: true
      is_up: true
      local_as: 65505
      remote_as: 65500
      remote_id: 10.255.1.1
      uptime: 49
    10.255.1.12:
      address_family:
        ipv4:
          accepted_prefixes: 6
          received_prefixes: 6
          sent_prefixes: 18
      description: CPE2
      is_enabled: true
      is_up: true
      local_as: 65505
      remote_as: 65505
      remote_id: 10.255.1.12
      uptime: 53
ok: [CPE2] =>
  msg:
    10.253.2.1:
      address_family:
        ipv4:
          accepted_prefixes: 18
          received_prefixes: 18
          sent_prefixes: 6
      description: PE2
      is_enabled: true
      is_up: true
      local_as: 65505
      remote_as: 65500
      remote_id: 10.255.1.2
      uptime: 49
    10.255.1.11:
      address_family:
        ipv4:
          accepted_prefixes: 18
          received_prefixes: 18
          sent_prefixes: 6
      description: CPE1
      is_enabled: true
      is_up: true
      local_as: 65505
      remote_as: 65505
      remote_id: 10.255.1.11
      uptime: 51
ok: [CUST_DC1] =>
  msg:
    10.253.3.1:
      address_family:
        ipv4:
          accepted_prefixes: 18
          received_prefixes: 18
          sent_prefixes: 4
      description: MGMT
      is_enabled: true
      is_up: true
      local_as: 65505
      remote_as: 65500
      remote_id: 10.255.1.3
      uptime: 72

TASK [verify : CHECK / Ping Remote Test IP(s) from source 10.223.1.252 / 255.255.255.0] ******************************************************************
ok: [CUST_DC1] => (item=10.223.0.254)
ok: [CPE2] => (item=10.223.0.254)
ok: [CPE1] => (item=10.223.0.254)
ok: [CUST_DC1] => (item=8.8.8.8)
ok: [CPE2] => (item=8.8.8.8)
ok: [CPE1] => (item=8.8.8.8)

TASK [verify : CHECK / print PINGTEST from source 10.223.1.252 / 255.255.255.0] **************************************************************************
ok: [CPE1] =>
  msg:
  - success:
      packet_loss: 0
      probes_sent: 5
      results:
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      rtt_avg: 91.0
      rtt_max: 265.0
      rtt_min: 21.0
      rtt_stddev: 0.0
  - success:
      packet_loss: 0
      probes_sent: 5
      results:
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      rtt_avg: 127.0
      rtt_max: 367.0
      rtt_min: 11.0
      rtt_stddev: 0.0
ok: [CPE2] =>
  msg:
  - success:
      packet_loss: 0
      probes_sent: 5
      results:
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      rtt_avg: 111.0
      rtt_max: 256.0
      rtt_min: 18.0
      rtt_stddev: 0.0
  - success:
      packet_loss: 0
      probes_sent: 5
      results:
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      rtt_avg: 72.0
      rtt_max: 321.0
      rtt_min: 9.0
      rtt_stddev: 0.0
ok: [CUST_DC1] =>
  msg:
  - success:
      packet_loss: 0
      probes_sent: 5
      results:
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      - ip_address: 10.223.0.254
        rtt: 0.0
      rtt_avg: 2.0
      rtt_max: 3.0
      rtt_min: 2.0
      rtt_stddev: 0.0
  - success:
      packet_loss: 0
      probes_sent: 5
      results:
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      - ip_address: 8.8.8.8
        rtt: 0.0
      rtt_avg: 3.0
      rtt_max: 5.0
      rtt_min: 3.0
      rtt_stddev: 0.0

TASK [verify : CHECK NAT / WITH SH IP NA TR] *************************************************************************************************************
ok: [CUST_DC1]
ok: [CPE2]
ok: [CPE1]

TASK [verify : CHECK NAT / Print SH IP NA TR] ************************************************************************************************************
ok: [CPE1] =>
  msg:
  - - ''
ok: [CPE2] =>
  msg:
  - - Pro Inside global         Inside local          Outside local         Outside global
    - icmp 10.123.1.252:13      10.223.1.252:13       8.8.8.8:13            8.8.8.8:13
    - icmp 10.123.1.253:11      10.223.1.253:11       8.8.8.8:11            8.8.8.8:11
    - '--- 10.123.1.252          10.223.1.252          ---                   ---'
    - '--- 10.123.1.253          10.223.1.253          ---                   ---'
ok: [CUST_DC1] =>
  msg:
  - - ''

PLAY RECAP ***********************************************************************************************************************************************
CPE1                       : ok=45   changed=9    unreachable=0    failed=0
CPE2                       : ok=45   changed=9    unreachable=0    failed=0
CUST_DC1                   : ok=46   changed=9    unreachable=0    failed=0
